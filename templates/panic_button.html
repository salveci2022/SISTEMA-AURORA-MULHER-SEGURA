<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Aurora Mulher Segura - SOS</title>
  
  <!-- Meta tags PWA -->
  <meta name="theme-color" content="#ff2d55">
  <meta name="description" content="Sistema de prote√ß√£o feminina com bot√£o de p√¢nico e notifica√ß√µes para pessoas de confian√ßa.">
  
  <!-- Manifest e √≠cones PWA -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest_aurora.json') }}">
  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/aurora-192.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/aurora-192.png') }}">
  
  <!-- Configura√ß√µes iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Aurora Mulher Segura">
  
  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  
  <style>
    /* Estados de conex√£o */
    body.offline .sos::after {
      content: " (offline)";
      font-size: 0.8em;
      color: #ff9500;
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    /* Status colors */
    .status-success { color: #34c759 !important; }
    .status-error { color: #ff3b30 !important; }
    .status-warning { color: #ff9500 !important; }
    .status-info { color: #007aff !important; }
  </style>
</head>
<body class="aurora-bg">

<main class="center-wrap">
  <section class="aurora-card">
    <div class="topbar">
      <div class="brand">
        <div class="brand-dot" aria-hidden="true">‚ôÄ</div>
        <div>
          <h1 class="brand-title">AURORA_MULHER_SEGURA</h1>
          <div class="brand-sub">Spy Life ¬∑ Prote√ß√£o Feminina 24h</div>
        </div>
      </div>
    </div>

    <div class="content">
      <h2 class="h1">BOT√ÉO DE P√ÇNICO</h2>
      <p class="center muted small">Vers√£o demonstrativa ‚Äî treine o fluxo de emerg√™ncia.</p>

      <div class="top-actions">
        <button type="button" id="btnReset" class="pill" aria-label="Reiniciar formul√°rio">Reiniciar</button>
        <button type="button" id="btnClear" class="pill" aria-label="Limpar todos os campos">Limpar</button>
        <button type="button" id="btnExit" class="pill" aria-label="Sair do sistema">Sair</button>
      </div>

      {% if trusted and trusted|length > 0 %}
      <div class="alert" style="margin-top:10px" role="status">
        <div class="small"><strong>Pessoas de confian√ßa cadastradas:</strong></div>
        <div class="chips" style="margin-top:8px" role="list">
          {% for n in trusted %}
            <div class="chip active" role="listitem" style="cursor:default" aria-label="Pessoa de confian√ßa: {{ n }}">{{ n }}</div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <form id="panicForm">
        <label class="label" for="name">Seu nome</label>
        <input class="input" id="name" name="name" placeholder="Ex: Ana, Maria..." autocomplete="name">
        
        <label class="label">Tipo de situa√ß√£o</label>
        <div class="chips" role="group" aria-label="Sele√ß√£o de tipo de situa√ß√£o">
          <button type="button" class="chip" data-situation="Viol√™ncia f√≠sica" aria-pressed="false">Viol√™ncia f√≠sica</button>
          <button type="button" class="chip" data-situation="Agress√£o verbal / amea√ßas" aria-pressed="false">Agress√£o verbal / amea√ßas</button>
          <button type="button" class="chip" data-situation="Persegui√ß√£o / Stalking" aria-pressed="false">Persegui√ß√£o / Stalking</button>
          <button type="button" class="chip" data-situation="Situa√ß√£o de risco" aria-pressed="false">Situa√ß√£o de risco</button>
        </div>
        <input type="hidden" id="selectedSituation" name="situation" value="Viol√™ncia f√≠sica">

        <label class="label" for="message">Mensagem (simula√ß√£o)</label>
        <textarea class="textarea" id="message" name="message" placeholder="Descreva rapidamente o que est√° acontecendo (opcional)."></textarea>

        <div class="alert" style="margin-top:10px" role="alert">
          <label for="shareLocation" style="display:flex;gap:10px;align-items:center;justify-content:center;cursor:pointer">
            <input type="checkbox" id="shareLocation" name="shareLocation" style="transform:scale(1.15)">
            <span><strong>Compartilhar localiza√ß√£o</strong> (s√≥ ser√° pedida se marcar)</span>
          </label>
          <div class="center small muted" style="margin-top:6px">
            Se n√£o marcar, o SOS vai sem localiza√ß√£o.
          </div>
        </div>
      </form>

      <div class="sos-wrap">
        <button class="sos" id="sosBtn" type="button" aria-label="Bot√£o SOS - toque e segure por 1.2 segundos para ativar">
          <div>
            <div class="sos-text">SOS</div>
            <div class="sos-sub">TOQUE E SEGURE</div>
          </div>
        </button>
      </div>

      <div id="status" class="center small" style="min-height:18px" role="status" aria-live="polite"></div>

      <div class="center small muted" style="margin-top:10px">
        <a class="link" href="/trusted/login">Pessoa de confian√ßa</a> ¬∑
        <a class="link" href="/panel/login">Admin</a> ¬∑
        <a class="link" href="/health">Diagn√≥stico</a>
      </div>
    </div>
  </section>
</main>

<!-- JavaScript principal -->
<script src="{{ url_for('static', filename='js/panic.js') }}"></script>

<script>
// ================================
// INICIALIZA√á√ÉO E CONFIGURA√á√ïES
// ================================

// Registrar Service Worker para PWA
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("{{ url_for('static', filename='sw_aurora.js') }}")
      .then(reg => console.log("‚úÖ Service Worker registrado:", reg.scope))
      .catch(err => console.log("‚ùå Erro ao registrar Service Worker:", err));
  });
}

// ================================
// MANIPULA√á√ÉO DOS CHIPS DE SITUA√á√ÉO
// ================================
document.addEventListener('DOMContentLoaded', function() {
  // Configurar chips de situa√ß√£o
  const chips = document.querySelectorAll('.chip[data-situation]');
  const selectedInput = document.getElementById('selectedSituation');
  
  chips.forEach(chip => {
    chip.addEventListener('click', function() {
      // Remover sele√ß√£o de todos
      chips.forEach(c => {
        c.classList.remove('active');
        c.setAttribute('aria-pressed', 'false');
      });
      
      // Selecionar este
      this.classList.add('active');
      this.setAttribute('aria-pressed', 'true');
      if (selectedInput) {
        selectedInput.value = this.dataset.situation;
      }
    });
  });

  // Configurar bot√µes de controle
  const btnReset = document.getElementById('btnReset');
  const btnClear = document.getElementById('btnClear');
  const btnExit = document.getElementById('btnExit');
  const statusDiv = document.getElementById('status');

  if (btnReset) {
    btnReset.addEventListener('click', () => {
      document.getElementById('panicForm').reset();
      chips.forEach(c => {
        c.classList.remove('active');
        c.setAttribute('aria-pressed', 'false');
      });
      // Selecionar primeira op√ß√£o
      if (chips.length > 0) {
        chips[0].click();
      }
      if (statusDiv) {
        statusDiv.textContent = 'Formul√°rio reiniciado';
        statusDiv.className = 'center small status-info';
        setTimeout(() => {
          statusDiv.textContent = '';
          statusDiv.className = 'center small';
        }, 2000);
      }
    });
  }

  if (btnClear) {
    btnClear.addEventListener('click', () => {
      document.getElementById('panicForm').reset();
      chips.forEach(c => {
        c.classList.remove('active');
        c.setAttribute('aria-pressed', 'false');
      });
      if (selectedInput) {
        selectedInput.value = '';
      }
      if (statusDiv) {
        statusDiv.textContent = 'Todos os campos limpos';
        statusDiv.className = 'center small status-success';
        setTimeout(() => {
          statusDiv.textContent = '';
          statusDiv.className = 'center small';
        }, 2000);
      }
    });
  }

  if (btnExit) {
    btnExit.addEventListener('click', () => {
      if (confirm('Tem certeza que deseja sair do sistema?')) {
        window.location.href = '/';
      }
    });
  }

  // Selecionar primeira op√ß√£o por padr√£o
  if (chips.length > 0 && !selectedInput.value) {
    chips[0].click();
  }
});

// ================================
// GERENCIAMENTO DE CONEX√ÉO E SINCRONIZA√á√ÉO OFFLINE
// ================================

document.addEventListener('DOMContentLoaded', function() {
  const statusDiv = document.getElementById('status');
  const sosBtn = document.getElementById('sosBtn');
  
  // Fun√ß√£o para atualizar status da conex√£o
  function updateConnectionStatus() {
    if (!navigator.onLine) {
      // Offline
      document.body.classList.add('offline');
      if (statusDiv) {
        statusDiv.innerHTML = '<span class="status-warning">‚ö†Ô∏è Voc√™ est√° offline. Alerta ser√° salvo localmente.</span>';
      }
      console.log('Aurora: Modo offline detectado');
    } else {
      // Online
      document.body.classList.remove('offline');
      if (statusDiv && statusDiv.textContent.includes('offline')) {
        statusDiv.innerHTML = '<span class="status-success">‚úÖ Conex√£o restaurada!</span>';
        setTimeout(() => {
          if (statusDiv) {
            statusDiv.textContent = '';
            statusDiv.className = 'center small';
          }
        }, 3000);
      }
      console.log('Aurora: Online ‚úÖ');
    }
  }

  // Verificar conex√£o ao carregar
  updateConnectionStatus();

  // Monitorar mudan√ßas de conex√£o
  window.addEventListener('online', updateConnectionStatus);
  window.addEventListener('offline', updateConnectionStatus);

  // Configurar sincroniza√ß√£o offline (se suportado)
  if ('serviceWorker' in navigator && sosBtn) {
    navigator.serviceWorker.ready
      .then(registration => {
        console.log('‚úÖ Service Worker pronto:', registration.active?.scriptURL);
        
        // Verificar suporte a SyncManager
        if ('sync' in registration) {
          console.log('‚úÖ SyncManager dispon√≠vel');
          
          // Registrar sincroniza√ß√£o ao pressionar o bot√£o SOS
          sosBtn.addEventListener('touchstart', function() {
            registration.sync.register('sync-alerts')
              .then(() => {
                console.log('üì° Sincroniza√ß√£o registrada (touch)');
              })
              .catch(err => {
                console.log('SyncManager error:', err);
              });
          });
          
          sosBtn.addEventListener('mousedown', function() {
            registration.sync.register('sync-alerts')
              .then(() => {
                console.log('üì° Sincroniza√ß√£o registrada (mouse)');
              })
              .catch(err => {
                console.log('SyncManager error:', err);
              });
          });
        } else {
          console.log('‚ÑπÔ∏è SyncManager n√£o dispon√≠vel, usando fallback');
        }
        
        // Verificar alertas pendentes quando a conex√£o voltar
        window.addEventListener('online', function() {
          registration.sync.getTags?.()
            .then(tags => {
              if (tags && tags.includes('sync-alerts')) {
                console.log('üîÑ Alertas pendentes detectados, sincronizando...');
              }
            })
            .catch(() => {
              // Fallback silencioso
            });
        });
      })
      .catch(err => {
        console.log('Service Worker n√£o dispon√≠vel:', err);
      });
  } else {
    console.log('‚ÑπÔ∏è Service Worker n√£o suportado neste navegador');
  }

  // Verificar periodicamente por alertas pendentes (fallback)
  if (localStorage) {
    setInterval(function() {
      try {
        const pendingAlerts = JSON.parse(localStorage.getItem('aurora_pending_alerts') || '[]');
        if (pendingAlerts.length > 0 && navigator.onLine) {
          console.log(`üìã ${pendingAlerts.length} alerta(s) pendente(s) encontrado(s)`);
          
          // Tentar sincronizar se tiver Service Worker
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready
              .then(registration => {
                if ('sync' in registration) {
                  return registration.sync.register('sync-alerts');
                }
              })
              .then(() => {
                console.log('üîÑ Sincroniza√ß√£o de alertas pendentes agendada');
              })
              .catch(err => {
                console.log('‚ùå N√£o foi poss√≠vel agendar sincroniza√ß√£o:', err);
              });
          }
        }
      } catch (e) {
        console.error('‚ùå Erro ao verificar alertas pendentes:', e);
      }
    }, 30000); // Verificar a cada 30 segundos
  }

  // Fun√ß√£o para salvar alerta offline (usada pelo panic.js)
  window.saveAlertOffline = function(alertData) {
    try {
      if (!localStorage) return null;
      
      const pendingAlerts = JSON.parse(localStorage.getItem('aurora_pending_alerts') || '[]');
      alertData.id = 'offline-' + Date.now();
      alertData.status = 'pending';
      alertData.created_at = new Date().toISOString();
      
      pendingAlerts.push(alertData);
      localStorage.setItem('aurora_pending_alerts', JSON.stringify(pendingAlerts));
      
      console.log(`üì¶ Alerta offline salvo: ${alertData.id}`);
      
      // Mostrar feedback ao usu√°rio
      if (statusDiv) {
        statusDiv.innerHTML = `<span class="status-warning">‚ö†Ô∏è Alerta salvo localmente (ID: ${alertData.id.substring(0, 8)})</span>`;
        setTimeout(() => {
          if (statusDiv && statusDiv.textContent.includes('salvo localmente')) {
            statusDiv.textContent = '';
            statusDiv.className = 'center small';
          }
        }, 5000);
      }
      
      // Tentar sincronizar imediatamente
      if ('serviceWorker' in navigator && 'sync' in navigator.serviceWorker) {
        navigator.serviceWorker.ready
          .then(registration => {
            return registration.sync.register('sync-alerts');
          })
          .then(() => {
            console.log('üì° Sincroniza√ß√£o agendada para alerta offline');
          })
          .catch(err => {
            console.log('‚ùå N√£o foi poss√≠vel agendar sincroniza√ß√£o:', err);
          });
      }
      
      return alertData.id;
    } catch (error) {
      console.error('‚ùå Erro ao salvar alerta offline:', error);
      return null;
    }
  };

  // Verificar e limpar alertas antigos
  try {
    if (localStorage) {
      const pendingAlerts = JSON.parse(localStorage.getItem('aurora_pending_alerts') || '[]');
      const now = new Date();
      const freshAlerts = pendingAlerts.filter(alert => {
        const created = new Date(alert.created_at);
        const ageInHours = (now - created) / (1000 * 60 * 60);
        return ageInHours < 24; // Manter apenas alertas com menos de 24h
      });
      
      if (freshAlerts.length < pendingAlerts.length) {
        localStorage.setItem('aurora_pending_alerts', JSON.stringify(freshAlerts));
        console.log(`üóëÔ∏è Removidos ${pendingAlerts.length - freshAlerts.length} alertas antigos`);
      }
    }
  } catch (e) {
    console.error('Erro ao limpar alertas antigos:', e);
  }
});

// ================================
// FUN√á√ïES √öTEIS PARA DEBUG (OPCIONAL)
// ================================

// Para debug: mostrar informa√ß√µes no console
console.log('üöÄ Aurora Mulher Segura - Bot√£o de P√¢nico');
console.log('üåê Online:', navigator.onLine);
console.log('üì± User Agent:', navigator.userAgent.substring(0, 50) + '...');

// Expor algumas fun√ß√µes para debug (opcional)
window.auroraDebug = {
  checkPendingAlerts: function() {
    try {
      const pending = JSON.parse(localStorage.getItem('aurora_pending_alerts') || '[]');
      console.log('üìä Alertas pendentes:', pending.length);
      return pending;
    } catch (e) {
      console.error('Erro:', e);
      return [];
    }
  },
  
  clearPendingAlerts: function() {
    if (confirm('Limpar todos os alertas pendentes?')) {
      localStorage.removeItem('aurora_pending_alerts');
      console.log('‚úÖ Alertas pendentes limpos');
    }
  },
  
  simulateOfflineAlert: function() {
    const testAlert = {
      name: 'Teste Offline',
      situation: 'Viol√™ncia f√≠sica',
      message: 'Este √© um alerta de teste salvo offline',
      timestamp: new Date().toISOString()
    };
    
    const id = window.saveAlertOffline?.(testAlert);
    if (id) {
      console.log('‚úÖ Alerta de teste salvo:', id);
      alert(`Alerta de teste salvo offline com ID: ${id}`);
    }
  }
};

</script>

</body>
</html>